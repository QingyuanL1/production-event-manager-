# Daily Plan 数据结构详细分析报告

## 文件概述

**文件位置**: `data/daily plan.xlsx`
**Sheet数量**: 2个
- Sheet1: 2025年3月期间的生产计划 (310行 × 18列)
- Sheet1 (2): 2024年11月期间的生产计划 (310行 × 18列)

## 数据结构分析

### 1. 表头结构 (多级表头)

Daily Plan采用**3级表头**结构：

```
第1行: [Line, Build Type, Part Number, 2025-03-01, 2025-03-02, 2025-03-02, ...]
第2行: [nan, nan, nan, 'Fri', 'Sat', 'Sat', ...]  
第3行: [nan, nan, nan, 'T4', 'T2', 'T4', ...]
第4行: [nan, nan, nan, 'Night', 'Day', 'Night', ...]  (班次类型)
```

**表头含义**:
- **第1级**: 日期信息 (datetime格式)
- **第2级**: 星期几 (Fri, Sat, Sun等)
- **第3级**: 班次编号 (T1, T2, T3, T4)
- **第4行**: 班次时段 (Day, Night)

### 2. 班次结构

**发现的班次模式**:
- **T1**: 白班 (Day)
- **T2**: 夜班 (Night) 
- **T3**: 夜班 (Night)
- **T4**: 夜班 (Night)

**典型的每日班次分配**:
```
周五: [T4]           (1个班次)
周六: [T2, T4]       (2个班次)  
周日: [T1, T3]       (2个班次)
周一: [T1, T3]       (2个班次)
周二: [T1, T3]       (2个班次)
```

### 3. 产线数据组织

#### 3.1 产线类型分布

**Sheet1 中的产线**:
```
真实产线 (F系列): F15, F16, F17, F18, F19, F20, F21, F22, F23, F24, F25, F26, F27, F29, F30, F35
系统类型: Forecast, LCA, LCA (带空格), SBR, PM/Convert, RWK, Recycle HGA, Hookup, TTL, Manual
```

**Sheet1 (2) 中的产线**: 基本相同，但多了F28产线

#### 3.2 各产线数据行数

```
F25: 2行数据 (在两个Sheet中)
F29: 2行数据
F24: 2行数据  
F23: 2行数据
其他F系列产线: 大多1行数据
系统类型: Forecast(18行), SBR(18行), PM/Convert(18行)等
```

### 4. F25产线详细分析

#### 4.1 Sheet1中F25产线数据

**F25产线配置**:
```
行1: F25 | EVANSBP 16H | 200723400
     产量分布: 2025-03-01(Fri T4): 2196
               2025-03-02(Sat T2): 1296  
               2025-03-05(Tue T3): 2160
               2025-03-06(Wed T1): 520

行2: F25 | Cimarron 10H | 203190400  
     (无产量数据)
```

**F25产能计算结果**:
- **最大单班次产量**: 2196
- **平均班次产量**: 1543.0
- **周总产量**: 6172
- **有效生产班次**: 4个

#### 4.2 Sheet1 (2)中F25产线数据
```
F25产线在此Sheet中无产量数据 (全为空值)
```

### 5. 产能获取方法分析

#### 5.1 当前代码的产能获取逻辑

现有的`_get_line_capacity()`方法采用**多级回退策略**：

1. **首先尝试**: 从capacity.xlsx文件获取
   - 查找包含"capacity"、"产能"等关键词的列
   - 查找数值大于1000的数值列

2. **次要方案**: 从Daily Plan推算
   - 找到目标产线的所有班次产量数据
   - 取最大单班次产量
   - 乘以1.2倍作为产能估算

3. **最后回退**: 使用硬编码默认值
   ```python
   default_capacities = {
       "F16": 6000,
       "F25": 9000,
       "F29": 8000, 
       "F32": 7500
   }
   ```

#### 5.2 实际产能数据对比

**从capacity.xlsx获取的F25数据**:
```
行25: F25 | Summit | 16 | ... (产能列待查)
行26: F25 | Summit | 20 | ... (产能列待查)
```

**从Daily Plan推算的F25产能**:
- Sheet1: 最大班次产量2196 → 估算产能 2635 (2196 × 1.2)
- Sheet1 (2): 无数据 → 使用默认值9000

### 6. 改进建议

#### 6.1 产能获取优化方案

1. **智能Daily Plan分析**:
   ```python
   # 分析多个sheet的历史数据
   # 取各sheet中该产线的最大产量
   # 应用更准确的产能系数 (例如1.1-1.3倍)
   ```

2. **增强capacity.xlsx解析**:
   ```python
   # 明确识别Prime Capacity/shift列
   # 按产品类型(Build Type)匹配产能
   # 考虑Head_Qty等配置参数
   ```

3. **动态产能计算**:
   ```python
   # 基于实际排产情况动态调整
   # 考虑产线切换、学习曲线等因素
   # 集成历史表现数据
   ```

#### 6.2 数据质量改进

1. **数据验证增强**:
   - 检查Daily Plan中的异常产量值
   - 验证班次分配的合理性
   - 交叉验证不同数据源

2. **产能阈值优化**:
   - 根据产线类型设置不同的产能系数
   - 考虑设备维护、效率衰减等因素

### 7. 代码实现建议

```python
def get_enhanced_line_capacity(self, target_line: str) -> Dict[str, Any]:
    """
    增强版产线产能获取方法
    
    Returns:
        {
            'capacity': float,           # 单班次产能
            'source': str,              # 数据来源
            'confidence': float,        # 置信度
            'historical_max': float,    # 历史最大产量
            'build_types': List[str]    # 支持的产品类型
        }
    """
    # 1. 分析所有sheet的历史数据
    # 2. 交叉验证capacity.xlsx
    # 3. 应用智能估算算法
    # 4. 返回详细的产能信息
```

## 结论

当前的Daily Plan数据结构完整且信息丰富，包含了详细的班次、产线、产品配置信息。F25产线在Sheet1中有实际的生产数据，可以作为产能推算的基础。

**关键发现**:
1. F25产线最大单班次产量为2196，显著低于当前默认产能9000
2. 现有的产能获取逻辑已经具备从实际数据推算的能力
3. 需要改进的是数据解析精度和多数据源融合策略

**建议实施优先级**:
1. **高优先级**: 优化Daily Plan数据解析，准确提取各产线的实际产能
2. **中优先级**: 增强capacity.xlsx文件的解析能力  
3. **低优先级**: 实施动态产能调整和历史数据分析